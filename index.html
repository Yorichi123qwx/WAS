<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± - Ø§Ù„Ø·Ù„Ø§Ø¨</title>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <!-- QR Code Scanner -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
    
    <!-- Face Detection -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/face-api.js/0.22.2/face-api.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 600px;
            width: 100%;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .time-display {
            font-size: 18px;
            opacity: 0.9;
            margin-top: 10px;
        }

        .content {
            padding: 40px 30px;
        }

        .step-indicator {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
        }

        .step {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e0e7ff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #667eea;
            transition: all 0.3s;
        }

        .step.active {
            background: #667eea;
            color: white;
            transform: scale(1.2);
        }

        .step.completed {
            background: #10b981;
            color: white;
        }

        .scan-section {
            text-align: center;
        }

        .scan-title {
            font-size: 24px;
            color: #333;
            margin-bottom: 20px;
        }

        .scan-box {
            background: #f3f4f6;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            border: 3px dashed #667eea;
        }

        #qr-reader {
            width: 100%;
            border-radius: 10px;
            overflow: hidden;
        }

        #video-container {
            position: relative;
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
        }

        #video {
            width: 100%;
            border-radius: 10px;
            transform: scaleX(-1);
        }

        #canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.2s;
            width: 100%;
            margin-top: 20px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .student-card {
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .student-photo {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: #667eea;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 32px;
            font-weight: bold;
        }

        .student-info {
            flex: 1;
            text-align: right;
        }

        .student-name {
            font-size: 20px;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .student-details {
            color: #666;
            font-size: 14px;
        }

        .success-message {
            text-align: center;
            padding: 40px 20px;
        }

        .success-icon {
            width: 100px;
            height: 100px;
            background: #10b981;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            animation: scaleIn 0.5s ease-out;
        }

        .success-icon svg {
            width: 60px;
            height: 60px;
            color: white;
        }

        @keyframes scaleIn {
            from {
                transform: scale(0);
            }
            to {
                transform: scale(1);
            }
        }

        .error-message {
            background: #fee2e2;
            color: #dc2626;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            color: #667eea;
            font-size: 18px;
            margin: 20px 0;
        }

        .spinner {
            width: 30px;
            height: 30px;
            border: 3px solid #e0e7ff;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .instructions {
            background: #fef3c7;
            color: #92400e;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            font-size: 14px;
            text-align: center;
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“ Ù†Ø¸Ø§Ù… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±</h1>
            <p>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ø°ÙƒÙŠ</p>
            <div class="time-display" id="currentTime"></div>
        </div>

        <div class="content">
            <!-- Step Indicator -->
            <div class="step-indicator">
                <div class="step active" id="step1">1</div>
                <div class="step" id="step2">2</div>
                <div class="step" id="step3">âœ“</div>
            </div>

            <!-- QR Code Scan Section -->
            <div class="scan-section" id="qrSection">
                <h2 class="scan-title">ğŸ“± Ø§Ù…Ø³Ø­ ÙƒÙˆØ¯ QR Ù…Ù† ÙƒØ§Ø±ØªÙƒ</h2>
                <div class="instructions">
                    Ù‚Ø±Ù‘Ø¨ Ø§Ù„ÙƒØ§Ø±Øª Ù…Ù† Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù„Ù…Ø³Ø­ ÙƒÙˆØ¯ QR
                </div>
                <div class="scan-box">
                    <div id="qr-reader"></div>
                </div>
                <button class="btn" id="startQrBtn">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø³Ø­</button>
            </div>

            <!-- Face Recognition Section -->
            <div class="scan-section hidden" id="faceSection">
                <h2 class="scan-title">ğŸ‘¤ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙˆØ¬Ù‡</h2>
                
                <div id="studentCard" class="student-card"></div>
                
                <div class="instructions">
                    Ø§Ù†Ø¸Ø± Ù…Ø¨Ø§Ø´Ø±Ø© Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù‡ÙˆÙŠØªÙƒ
                </div>
                
                <div class="scan-box">
                    <div id="video-container">
                        <video id="video" autoplay muted playsinline></video>
                        <canvas id="canvas"></canvas>
                    </div>
                </div>
                
                <div class="loading hidden" id="faceLoading">
                    <div class="spinner"></div>
                    <span>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙˆØ¬Ù‡...</span>
                </div>
                
                <button class="btn" id="verifyFaceBtn">ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙˆØ¬Ù‡</button>
            </div>

            <!-- Success Section -->
            <div class="scan-section hidden" id="successSection">
                <div class="success-message">
                    <div class="success-icon">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                    </div>
                    <h2 class="scan-title">âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ±Ùƒ Ø¨Ù†Ø¬Ø§Ø­!</h2>
                    <div id="successDetails"></div>
                </div>
                <button class="btn" id="newAttendanceBtn">ØªØ³Ø¬ÙŠÙ„ Ø·Ø§Ù„Ø¨ Ø¢Ø®Ø±</button>
            </div>

            <!-- Error Section -->
            <div id="errorMessage" class="error-message hidden"></div>
        </div>
    </div>

    <script>
        // ===== Firebase Configuration =====
        const firebaseConfig = {
            apiKey: "AIzaSyCVdv49IiDYrFiKhfVbpD79x3LKLHnbH1k",
            authDomain: "we-attendance-system.firebaseapp.com",
            projectId: "we-attendance-system",
            storageBucket: "we-attendance-system.firebasestorage.app",
            messagingSenderId: "507634052006",
            appId: "1:507634052006:web:fb8aef2a7a227c7e657d67",
            measurementId: "G-N09J816Q4D"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // ===== Global Variables =====
        let html5QrCode;
        let currentStudent = null;
        let faceModelsLoaded = false;

        // ===== Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ù„Ù„Ø·Ù„Ø§Ø¨ =====
        const studentsDB = {
            'STD001': {
                id: 'STD001',
                name: 'Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯ Ø¹Ù„ÙŠ',
                grade: 'Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„',
                department: 'Ø¨Ø±Ù…Ø¬Ø©'
            },
            'STD002': {
                id: 'STD002',
                name: 'ÙØ§Ø·Ù…Ø© Ø­Ø³Ù† Ù…Ø­Ù…ÙˆØ¯',
                grade: 'Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ',
                department: 'Ø´Ø¨ÙƒØ§Øª'
            },
            'STD003': {
                id: 'STD003',
                name: 'Ù…Ø­Ù…Ø¯ Ø£Ø­Ù…Ø¯ Ø³Ø¹ÙŠØ¯',
                grade: 'Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø«',
                department: 'Ø§ØªØµØ§Ù„Ø§Øª'
            }
        };

        // ===== Time Display =====
        function updateTime() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            };
            document.getElementById('currentTime').textContent = 
                now.toLocaleDateString('ar-EG', options);
        }
        setInterval(updateTime, 1000);
        updateTime();

        // ===== QR Code Scanner =====
        document.getElementById('startQrBtn').addEventListener('click', startQRScanner);

        function startQRScanner() {
            const qrReader = document.getElementById('qr-reader');
            
            html5QrCode = new Html5Qrcode("qr-reader");
            
            html5QrCode.start(
                { facingMode: "environment" },
                {
                    fps: 10,
                    qrbox: { width: 250, height: 250 }
                },
                onScanSuccess,
                onScanFailure
            ).catch(err => {
                showError('Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§: ' + err);
            });

            document.getElementById('startQrBtn').textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø³Ø­...';
            document.getElementById('startQrBtn').disabled = true;
        }

        function onScanSuccess(decodedText) {
            console.log('QR Code detected:', decodedText);
            
            // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø§Ø³Ø­
            html5QrCode.stop().then(() => {
                // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø·Ø§Ù„Ø¨
                const student = studentsDB[decodedText];
                
                if (student) {
                    currentStudent = student;
                    moveToFaceVerification();
                } else {
                    showError('Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± ØµØ­ÙŠØ­ Ø£Ùˆ Ø§Ù„Ø·Ø§Ù„Ø¨ ØºÙŠØ± Ù…Ø³Ø¬Ù„');
                    resetToQR();
                }
            });
        }

        function onScanFailure(error) {
            // ÙŠØ­Ø¯Ø« Ø¨Ø§Ø³ØªÙ…Ø±Ø§Ø± Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù…Ø³Ø­ - Ù†ØªØ¬Ø§Ù‡Ù„Ù‡
        }

        // ===== Face Verification =====
        async function moveToFaceVerification() {
            // ØªØ­Ø¯ÙŠØ« Step Indicator
            document.getElementById('step1').classList.remove('active');
            document.getElementById('step1').classList.add('completed');
            document.getElementById('step2').classList.add('active');

            // Ø¥Ø®ÙØ§Ø¡ Ù‚Ø³Ù… QR ÙˆØ¥Ø¸Ù‡Ø§Ø± Ù‚Ø³Ù… Face
            document.getElementById('qrSection').classList.add('hidden');
            document.getElementById('faceSection').classList.remove('hidden');

            // Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨
            displayStudentCard();

            // ØªØ­Ù…ÙŠÙ„ Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ¬Ù‡
            if (!faceModelsLoaded) {
                await loadFaceModels();
            }
        }

        function displayStudentCard() {
            const card = document.getElementById('studentCard');
            const firstLetter = currentStudent.name.charAt(0);
            
            card.innerHTML = `
                <div class="student-photo">${firstLetter}</div>
                <div class="student-info">
                    <div class="student-name">${currentStudent.name}</div>
                    <div class="student-details">
                        ${currentStudent.grade} - ${currentStudent.department}
                    </div>
                    <div class="student-details">
                        Ø§Ù„ÙƒÙˆØ¯: ${currentStudent.id}
                    </div>
                </div>
            `;
        }

        async function loadFaceModels() {
            try {
                const MODEL_URL = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/';
                
                await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
                await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
                await faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL);
                
                faceModelsLoaded = true;
                console.log('Face models loaded successfully');
            } catch (error) {
                console.error('Error loading face models:', error);
                showError('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ¬Ù‡');
            }
        }

        document.getElementById('verifyFaceBtn').addEventListener('click', startFaceVerification);

        async function startFaceVerification() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const loading = document.getElementById('faceLoading');
            
            loading.classList.remove('hidden');
            document.getElementById('verifyFaceBtn').disabled = true;

            try {
                // Ø¨Ø¯Ø¡ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'user' } 
                });
                video.srcObject = stream;

                // Ø§Ù†ØªØ¸Ø§Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
                await new Promise(resolve => {
                    video.onloadedmetadata = resolve;
                });

                // Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¥Ø·Ø§Ø± ÙˆØ§Ø¶Ø­
                await new Promise(resolve => setTimeout(resolve, 2000));

                // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§ÙƒØªØ´Ø§Ù Ø§Ù„ÙˆØ¬Ù‡
                const detection = await faceapi
                    .detectSingleFace(video, new faceapi.TinyFaceDetectorOptions())
                    .withFaceLandmarks()
                    .withFaceDescriptor();

                // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
                stream.getTracks().forEach(track => track.stop());
                video.srcObject = null;

                if (detection) {
                    // ØªÙ… Ø§ÙƒØªØ´Ø§Ù Ø§Ù„ÙˆØ¬Ù‡ Ø¨Ù†Ø¬Ø§Ø­
                    await recordAttendance();
                } else {
                    showError('Ù„Ù… ÙŠØªÙ… Ø§ÙƒØªØ´Ø§Ù ÙˆØ¬Ù‡. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰');
                    loading.classList.add('hidden');
                    document.getElementById('verifyFaceBtn').disabled = false;
                }
            } catch (error) {
                console.error('Face verification error:', error);
                showError('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙˆØ¬Ù‡: ' + error.message);
                loading.classList.add('hidden');
                document.getElementById('verifyFaceBtn').disabled = false;
            }
        }

        // ===== Record Attendance =====
        async function recordAttendance() {
            try {
                const now = new Date();
                const attendanceData = {
                    studentId: currentStudent.id,
                    studentName: currentStudent.name,
                    grade: currentStudent.grade,
                    department: currentStudent.department,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    date: now.toLocaleDateString('ar-EG'),
                    time: now.toLocaleTimeString('ar-EG'),
                    status: 'Ø­Ø§Ø¶Ø±',
                    method: 'QR + Face Recognition'
                };

                // Ø­ÙØ¸ ÙÙŠ Firebase
                await db.collection('attendance').add(attendanceData);

                // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ù†Ø¬Ø§Ø­
                showSuccess();
            } catch (error) {
                console.error('Error recording attendance:', error);
                showError('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ' + error.message);
            }
        }

        // ===== Success Screen =====
        function showSuccess() {
            document.getElementById('step2').classList.remove('active');
            document.getElementById('step2').classList.add('completed');
            document.getElementById('step3').classList.add('active');

            document.getElementById('faceSection').classList.add('hidden');
            document.getElementById('successSection').classList.remove('hidden');

            const now = new Date();
            document.getElementById('successDetails').innerHTML = `
                <div class="student-card">
                    <div class="student-photo">${currentStudent.name.charAt(0)}</div>
                    <div class="student-info">
                        <div class="student-name">${currentStudent.name}</div>
                        <div class="student-details">${currentStudent.grade} - ${currentStudent.department}</div>
                        <div class="student-details">â° ${now.toLocaleTimeString('ar-EG')}</div>
                    </div>
                </div>
            `;
        }

        document.getElementById('newAttendanceBtn').addEventListener('click', resetToQR);

        // ===== Error Handling =====
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = 'âš ï¸ ' + message;
            errorDiv.classList.remove('hidden');
            
            setTimeout(() => {
                errorDiv.classList.add('hidden');
            }, 5000);
        }

        // ===== Reset =====
        function resetToQR() {
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„ Ø´ÙŠØ¡
            currentStudent = null;
            
            document.getElementById('step1').classList.add('active');
            document.getElementById('step1').classList.remove('completed');
            document.getElementById('step2').classList.remove('active', 'completed');
            document.getElementById('step3').classList.remove('active', 'completed');

            document.getElementById('qrSection').classList.remove('hidden');
            document.getElementById('faceSection').classList.add('hidden');
            document.getElementById('successSection').classList.add('hidden');
            document.getElementById('faceLoading').classList.add('hidden');

            document.getElementById('startQrBtn').textContent = 'Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø³Ø­';
            document.getElementById('startQrBtn').disabled = false;
            document.getElementById('verifyFaceBtn').disabled = false;

            // Ù…Ø³Ø­ Ù‚Ø§Ø±Ø¦ QR
            const qrReader = document.getElementById('qr-reader');
            qrReader.innerHTML = '';
        }
    </script>
</body>
</html>
